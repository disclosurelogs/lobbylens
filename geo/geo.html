<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
 "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
    <title>Map</title>
   <link rel="stylesheet" href="reset-fonts-grids.css" type="text/css">
   <link href="default.css" rel="stylesheet" type="text/css"/>

    <link rel="stylesheet" href="style.css" type="text/css" />
    <script src="OpenLayers.js" type="text/javascript"></script>


    <script type="text/javascript">


        var map;
        var zoom = 3;

        OpenLayers.IMAGE_RELOAD_ATTEMPTS = 3;
        OpenLayers.Util.onImageLoadErrorColor = "blue";


        window.onload = function (){
            var options = {
                projection: new OpenLayers.Projection("EPSG:900913"),
                displayProjection: new OpenLayers.Projection("EPSG:4326"),
                units: "m",
                numZoomLevels: 18,
                maxResolution: 156543.0339,
                maxExtent: new OpenLayers.Bounds(-20037508, -20037508,
                                                 20037508, 20037508.34)
            };


            map = new OpenLayers.Map('bigmap', options);



            var mapnik = new OpenLayers.Layer.TMS(
                "OpenStreetMap",
                "http://a.tile.openstreetmap.org/",
                {
                    type: 'png', getURL: osm_getTileURL,
                    displayOutsideMaxExtent: true,
                    wrapDateLine: true
                }
            );

            var vector = new OpenLayers.Layer.Vector("Editable Vectors");
            map.addControl(new OpenLayers.Control.LayerSwitcher());
            map.addControl(new OpenLayers.Control.MousePosition());
            var centre = new OpenLayers.LonLat(16807384.8384, -4004215.78717);

	        function osm_getTileURL(bounds) {
	            var res = this.map.getResolution();
	            var x = Math.round((bounds.left - this.maxExtent.left) / (res * this.tileSize.w));
	            var y = Math.round((this.maxExtent.top - bounds.top) / (res * this.tileSize.h));
	            var z = this.map.getZoom();
	            var limit = Math.pow(2, z);

	            if (y < 0 || y >= limit) {
	                return OpenLayers.Util.getImagesLocation() + "404.png";
	            } else {
	                x = ((x % limit) + limit) % limit;
	                return this.url + z + "/" + x + "/" + y + "." + this.type;
	            }
	        }

            /*
             * Layer style
             */
            // we want opaque external graphics and non-opaque internal graphics
            var layer_style = OpenLayers.Util.extend({}, OpenLayers.Feature.Vector.style['default']);
            layer_style.fillOpacity = 0.2;
            layer_style.graphicOpacity = 1;

            // create the layer styleMap with a simple symbolizer template
                var layer1 = new OpenLayers.Layer.Vector('Points', {
                    styleMap: new OpenLayers.StyleMap({
                    pointRadius: "${type}", // based on feature.attributes.type
                    fillColor: "#333333",
                    fillOpacity: 0.5,
                    strokeColor: "#96513c",
                    strokeWidth: 1
                })
            });
            //layer1.addFeatures(pointList);

            //map.addLayers([mapnik, elct]);
            map.addLayer(mapnik)

            var yelp = new OpenLayers.Icon("http://openlayers.org/dev/img/marker.png", new OpenLayers.Size(20,29));
            //var newl = new OpenLayers.Layer.GeoRSS( 'Yelp GeoRSS', 'http://localhost/cgi-bin/geo_feed.py', {'icon':yelp});
            var strategy = new OpenLayers.Strategy.Cluster({distance: 15, threshold: 3});
            var strategy2 = new OpenLayers.Strategy.BBOX({resFactor: 1.1});

            var newl = new OpenLayers.Layer.Vector("POIs", {
                strategies: [strategy, strategy2],
                protocol: new OpenLayers.Protocol.HTTP({
                    url: "http://localhost/cgi-bin/geo_feed.py",
                    format: new OpenLayers.Format.GeoRSS()
                })
            });


            map.addLayer(newl);

            map.setCenter(centre, zoom);
            //vectorLayer.addFeatures([lineFeature]);

        }

        function lonLatToMercator(ll) {

           var lon = ll.lon * 20037508.34 / 180;
           var lat = Math.log(Math.tan((90 + ll.lat) * Math.PI / 360)) / (Math.PI / 180);
           lat = lat * 20037508.34 / 180;
           return new OpenLayers.LonLat(lon, lat);
        }

    </script>
</head>
<body>
<div id="doc4" class="yui-t7">

<div id="bd">
	<div class="yui-g">
        <div id="bigmap"></div>

        <br />
   	</div>
    </div>
</div>

</body>
</html>


